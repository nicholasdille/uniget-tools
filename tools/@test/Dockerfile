#syntax=docker/dockerfile:1.4.2

ARG ref=main
FROM ghcr.io/nicholasdille/docker-setup/docker:${ref}         AS docker
FROM ghcr.io/nicholasdille/docker-setup/fuse-overlayfs:${ref} AS fuse-overlayfs
FROM ghcr.io/nicholasdille/docker-setup/trivy:${ref}          AS trivy

FROM ubuntu:22.04 AS base

SHELL [ "bash", "-e", "-c"]

COPY <<no-recommends <<no-suggests /etc/apt/apt.conf.d/
APT::Install-Recommends "false";
no-recommends
APT::Install-Suggests "false";
no-suggests

COPY --link --from=docker         / /
COPY --link --from=fuse-overlayfs / /
COPY --link --from=trivy          / /

# TODO: Replace jq with dasel?
RUN <<EOF
apt-get update
apt-get -y install jq
EOF

# TODO: Use dedicated sub-shell for each post_install script
# TODO: Implement mocked functions
RUN <<EOF
mkdir -p /var/cache/docker-setup
export prefix=
export target=${prefix}/usr/local
export relative_target=/usr/local
export docker_setup_cache=/var/cache/docker-setup
export docker_setup_contrib=/var/lib/docker-setup/contrib
export docker_hub_mirror=
export docker_address_base=
export docker_address_size=
function has_tool() {
    false
}
function tool_will_be_installed() {
    false
}
function wait_for_tool() {
    :
}
function docker_is_running() {
    true
}
function wait_for_docker() {
    true
}
function info() {
    :
}
function warning() {
    :
}
function error() {
    :
}
function is_debian() {
    true
}
function is_clearlinux() {
    false
}
function is_redhat() {
    false
}
function is_alpine() {
    false
}
function has_systemd() {
    false
}
FILES="$(find /var/lib/docker-setup/post_install -type f -name \*.sh)"
for FILE in ${FILES}; do
    echo "Running post install for $(basename "${FILE}" .sh)"
    source ${FILE}
done
rm -rf /var/cache/docker-setup
EOF

LABEL org.opencontainers.image.source="https://github.com/nicholasdille/docker-setup" \
      org.opencontainers.image.description="Image generated by docker-setup" \
      org.opencontainers.image.version="${ref}"